(() => {var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break}}catch(err){_d=true;_e=err}finally{try{if(!_n&&_i['return'])_i['return']()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr)){return arr}else if(Symbol.iterator in Object(arr)){return sliceIterator(arr,i)}else{throw new TypeError('Invalid attempt to destructure non-iterable instance')}}}();var _window$BlockChainUti=window.BlockChainUtils,fixD=_window$BlockChainUti.fixD,fixRate=_window$BlockChainUti.fixRate;var setDepthData=function setDepthData(symbol,data,rate,depthValue,lan){var dataTypeKey=Object.keys(data);var priceFix=depthValue;var volumeFix=symbol.volume||0;var names=symbol.name.split('/');var symbolName=names[0];var marketName=names[1]||symbol.quoteSymbol;var depthListData={};var maxTotal=0;dataTypeKey.forEach(function(item){if(item!=='newData'){var objItem=data[item];var totalNum=0;var maxval=0;var dataArr=[];var objKeys=null;if(item==='asks'){objKeys=Object.keys(objItem).sort(function(a,b){return a-b})}else{objKeys=Object.keys(objItem).sort(function(a,b){return b-a})}objKeys.forEach(function(itemKey,index){var itemArr=objItem[itemKey];if(Number(fixD(itemArr[1]),priceFix)!==0&&dataArr.length<150){maxval=maxval<itemArr[1]?itemArr[1]:maxval;totalNum+=itemArr[1];var ratePrice=fixRate(itemArr[0],rate,marketName,lan);var objd={rate:ratePrice,total:fixD(totalNum,volumeFix),price:fixD(itemArr[0],priceFix),vol:fixD(itemArr[1],volumeFix),diff:itemArr[2]};if(data.newData&&data.newData.indexOf(itemArr[0])<0){objd.diff=0}dataArr.push(objd)}});depthListData[item]=dataArr;if(maxTotal<maxval){maxTotal=maxval}}});return{symbol:symbol.name,depthMaxNumber:maxTotal,asksData:depthListData.asks.reverse(),buyData:depthListData.buys}};var currentData=[];var pYname=null;var aYname='';var setEchartsData=function setEchartsData(dataList,type,currentSymbol){var volumeFix=currentSymbol.volume;var defaultThreshold=currentSymbol.defaultThreshold||0.1;if(type==='current'){pYname=currentSymbol.name;if(dataList){currentData[0]=Number(dataList.price);currentData[1]=Number(dataList.vol)}return}if(!type){aYname=currentSymbol.name}if(pYname!==aYname)return false;var middlePrice=currentData[0];var j=0;var minval=null;var maxval=null;var yminval=null;var ymaxval=null;var buysArr=[];var asksArr=[];var asksKey=Object.keys(dataList.asks);var buysKey=Object.keys(dataList.buys);if(dataList&&asksKey.length>1||buysKey.length>1){var EachartDat={};var keyArr=Object.keys(dataList);keyArr.forEach(function(key){if(key!=='newData'){var i=0;EachartDat[key]=[];var objItem=dataList[key];var objKeys=key==='asks'?Object.keys(objItem).sort(function(a,b){return a-b}):Object.keys(objItem).sort(function(a,b){return b-a});objKeys.forEach(function(item,index){if(Number(objItem[item][1])!==0){objItem[item][0]=Number(objItem[item][0]);objItem[item][1]=Number(fixD(objItem[item][1]+i,volumeFix));var _objItem$item=_slicedToArray(objItem[item],2);i=_objItem$item[1];EachartDat[key].push(objItem[item])}})}});buysArr=EachartDat.buys.reverse();asksArr=EachartDat.asks;var buyMax=buysArr.length&&buysArr[buysArr.length-1][0]||0;var asksMin=asksArr[0]&&asksArr[0][0]||0;if(!middlePrice||middlePrice===0){middlePrice=(buyMax+asksMin)/2}minval=middlePrice-middlePrice*defaultThreshold;maxval=middlePrice+middlePrice*defaultThreshold;buysArr=buysArr.filter(function(item){return item[0]>=minval});asksArr=asksArr.filter(function(item){return item[0]<=maxval});buysArr.length&&buysArr.unshift([minval,buysArr[0][1]]);asksArr.length&&asksArr.push([maxval,asksArr[asksArr.length-1][1]]);var buySpks=minval===0?0:(middlePrice-minval)/middlePrice;var askSpks=maxval===0?0:(maxval-middlePrice)/middlePrice;var spks=0.15;if(buySpks>spks&&askSpks>spks){spks=buySpks>=askSpks?askSpks:buySpks}else{spks=buySpks>=askSpks?buySpks:askSpks}spks>1&&(spks=1);if(!buysArr.length&&asksArr.length){yminval=asksArr[0][1];ymaxval=asksArr[asksArr.length-1][1]}else if(!asksArr.length&&buysArr.length){yminval=buysArr[buysArr.length-1][1];ymaxval=buysArr[0][1]}else{yminval=buysArr[buysArr.length-1][1]>asksArr[0][1]?asksArr[0][1]:buysArr[buysArr.length-1][1];ymaxval=buysArr[0][1]>asksArr[asksArr.length-1][1]?buysArr[0][1]:asksArr[asksArr.length-1][1]}}return{buysArr:buysArr,asksArr:asksArr,minval:minval,maxval:maxval,yminval:yminval,ymaxval:ymaxval}};var oldData={};function dataTemplate(item,WSdata,rateData,oldObj,lan){var names=item.name.split('/');var symbol=names[0];var unit=names[1];var showNames=item.showName?item.showName.split('/'):null;var showSymbol=showNames?showNames[0]:null;var showUnit=showNames?showNames[1]:null;if(!WSdata.renew.length||WSdata.renew.indexOf(item.symbol.toLowerCase())!==-1||!oldData[item.name]){var data=WSdata[item.symbol.toLowerCase()];var _oldObj=oldData[item.name];var symbolItem={};if(data){var marketName=item.name.split('/')[1]||item.quoteSymbol;var priceFix=item.price||item.pricePrecision;var volumeFix=item.volume||0;var oldClose=_oldObj?_oldObj.closes:'';var close=fixD(data.close.toString(),priceFix);var cN=parseFloat(close);var ocN=parseFloat(oldClose);var rate=0;if(rateData){rate=fixRate(data.close,rateData,marketName,lan)}var priceClass='';if(ocN){if(ocN>cN){priceClass='u-4-cl'}if(ocN<cN){priceClass='u-1-cl'}}var num=Math.abs(data.rose*10000/100);var rose=null;var rc=null;if(!parseFloat(num)){rose='0.00%'}else{rose=''+Number(num.toString().match(/^\d+(?:\.\d{0,2})?/));if(data.rose<0){rc='u-4-cl';rose='-'+rose+'%'}if(data.rose>0){rc='u-1-cl';rose='+'+rose+'%'}if(data.rose===0){rc='';rose='0.00%'}}if(showNames){symbolItem.showSymbol={symbol:showSymbol,unit:showUnit}}symbolItem.symbol={symbol:symbol,unit:unit};symbolItem.closes=close;symbolItem.close={class:priceClass,data:close,price:rate};symbolItem.roses=rose;symbolItem.rose={class:rc,data:rose};symbolItem.IsST=item.IsST||0;symbolItem.newcoinFlag=item.newcoinFlag;symbolItem.sort=item.sort;symbolItem.name=item.name;symbolItem.multiple=item.multiple||'0';symbolItem.low=fixD(data.low,priceFix);symbolItem.vol=fixD(data.vol,volumeFix);symbolItem.high=fixD(data.high,priceFix);symbolItem.amount=fixD(data.amount,priceFix);symbolItem.holdAmount=fixD(data.holdAmount,priceFix);symbolItem.holdVolume=fixD(data.holdVolume,volumeFix);oldData[item.name]=symbolItem}else{if(showNames){symbolItem.showSymbol={symbol:showSymbol,unit:showUnit}}symbolItem.symbol={symbol:symbol,unit:unit};symbolItem.closes=-99999;symbolItem.close={class:'',data:'--',price:'--'};symbolItem.roses=-99999;symbolItem.rose={class:'',data:'--'};symbolItem.isShow=true;symbolItem.amount='--';symbolItem.low='--';symbolItem.high='--';symbolItem.vol='--';symbolItem.name=item.name;symbolItem.sort=item.sort;symbolItem.IsST=item.IsST||0;symbolItem.newcoinFlag=item.newcoinFlag;oldData[item.name]=symbolItem}return symbolItem}return oldData[item.name]}var setMarketData=function setMarketData(symbolList,data,rateData,lan){var marketData={};var symbolsKeys=Object.keys(symbolList);symbolsKeys.forEach(function(item){if(symbolList[item].symbol){var symbolkey=symbolList[item].symbol;var itemData=data[symbolkey]||'';marketData[item]=dataTemplate(symbolList[item],data,rateData,oldData[symbolkey],lan)}});return marketData};var setTradeData=function setTradeData(symbol,datalist,rateData,lan){var tradeData=[];var queueData=[];if(datalist&&datalist.length){var priceFix=symbol.price||symbol.pricePrecision;var volumeFix=symbol.volume||0;var marketName=symbol.name.split('/')[1];var keyArr=[];var num=0;datalist.forEach(function(item,index){if(num<150){var rate=fixRate(item.price,rateData,marketName,lan);var nextprice=datalist[index+1]?datalist[index+1].price:null;var rose=null;if(nextprice){if(nextprice>item.price){rose='down'}else if(nextprice<item.price){rose='up'}}tradeData.push({side:item.side==='SELL'?'u-4-cl':'u-1-cl',time:formatTime(item.ts).split(' ')[1],rate:rate,ts:item.ts,price:fixD(item.price,priceFix),vol:fixD(item.vol,volumeFix),rose:rose,date:new Date().getTime()+index,change:item.change});keyArr.push(item.ts);queueData.push(item);num+=1}});return{tradeData:tradeData.sort(function(a,b){return b.ts-a.ts}),queueDataList:queueData}}return{tradeData:tradeData,queueDataList:queueData}};var _window=window,emitte=_window.emitte;var getScript=window.BlockChainUtils.getScript;getScript(window.staticDomain+'/home/static/js/pako.min.js').then(function(){var sendMessage=function sendMessage(type,subType,data){emitter.emit('websocketSend',{type:type,data:{type:subType,WsData:data}})};var webSocketUrl=null;var lan=null;var rate=null;var symbolAll=null;var symbolListArr=null;var depthValue=null;var MywebSocket=null;var currentSymbol=null;var marketData={renew:[]};var marketDataKey=[];var rateData=null;var marketTime={socketTime:0,contrastTime:500,outTime:500,timeOut:null};var tradeData=null;var tradeTime={socketTime:0,contrastTime:50,outTime:50,timeOut:null};var curreentDepth=null;var tickData={asks:'',buys:''};var depthTime={socketTime:0,contrastTime:45,outTime:50,timeOut:null};var echartsData={};var echartsTime={socketTime:0,contrastTime:50,outTime:50,timeOut:null};var marketReviewSend=function marketReviewSend(){if(MywebSocket){MywebSocket.send(JSON.stringify({event:'req',params:{channel:'review'}}))}};var markteWsSend=function markteWsSend(type,symbolCurrent,symbolList){if(symbolList&&MywebSocket){var symbolKeys=Object.keys(symbolList);symbolKeys.forEach(function(item){if(symbolList[item].symbol){var symbol=symbolList[item].symbol.toLowerCase();var u=1;if(type==='unsub'&&item===symbolCurrent){u=0}else{u=1}if(MywebSocket&&u){MywebSocket.send(JSON.stringify({event:type,params:{channel:'market_'+symbol+'_ticker',cb_id:symbol}}))}}})}};var tradeWsSend=function tradeWsSend(type,symbolCurrent){if(MywebSocket&&symbolCurrent){var symbolArr=symbolCurrent.toLowerCase().split('/');var symbol=symbolArr[1]?symbolArr[0]+symbolArr[1]:symbolArr[0];var num=100;MywebSocket.send(JSON.stringify({event:type,params:{channel:'market_'+symbol+'_trade_ticker',cb_id:symbol,top:num}}))}};var depthWsSend=function depthWsSend(type,symbolCurrent,depth){if(MywebSocket&&symbolCurrent){var symbolArr=symbolCurrent.toLowerCase().split('/');var symbol=symbolArr[1]?symbolArr[0]+symbolArr[1]:symbolArr[0];MywebSocket.send(JSON.stringify({event:type,params:{channel:'market_'+symbol+'_depth_step'+depth,cb_id:symbol}}))}};var klineWsSend=function klineWsSend(parameters){var type=parameters.type;var symbol=parameters.symbol;var lastTimeS=parameters.lastTimeS;var lTime=parameters.lTime;var number=parameters.number;var params={channel:'market_'+symbol+'_kline_'+lastTimeS,cb_id:symbol};if(lTime){params.endIdx=lTime;params.pageSize=number}if(MywebSocket.readyState===1){MywebSocket.send(JSON.stringify({event:type,params:params}))}};var timeoutTop=null;var lockReconnectTop=false;var lockDestroyTop=false;clearTimeout(timeoutTop);var heartCheckTop=function heartCheckTop(){var timeout=30000;if(MywebSocket.readyState!==3){clearTimeout(timeoutTop);if(!lockReconnectTop&&!lockDestroyTop){timeoutTop=setTimeout(function(){console.log('\u672A\u68C0\u6D4B\u5230\u5FC3\u8DF3\u4F53\u5F81');MywebSocket.send('1111');MywebSocket.close()},timeout)}}};var reconnectTop=function reconnectTop(type){if(!lockReconnectTop&&!lockDestroyTop){lockReconnectTop=true;setTimeout(function(){creatWebSocket(type)},3000)}};var creatWebSocket=function creatWebSocket(){if(webSocketUrl){MywebSocket=new WebSocket(webSocketUrl);MywebSocket.binaryType='arraybuffer';webSocketEvent();lockReconnectTop=false}};var ii=0;var webSocketEvent=function webSocketEvent(){MywebSocket.onopen=function(){sendMessage('WEBSOCKET_ON_OPEN',MywebSocket.readyState);heartCheckTop()};MywebSocket.onclose=function(data){reconnectTop();sendMessage('WEBSOCKET_ON_OPEN',false)};MywebSocket.onmessage=function(event){if(!currentSymbol){return false}var symbolArr=currentSymbol.toLowerCase().split('/');var symbol=symbolArr[1]?symbolArr[0]+symbolArr[1]:symbolArr[0];var ua=new Uint8Array(event.data);var data=JSON.parse(pako.inflate(ua,{to:'string'}));var dtype=void 0;var symbolType=void 0;heartCheckTop();if(data.ping){MywebSocket.send(JSON.stringify({pong:data.ping}))}else{if(data.channel){if(symbolListArr.tradeType&&symbolListArr.tradeType==='contract'){dtype=data.channel.split('_')[3];symbolType=data.channel.split('_')[1]+'_'+data.channel.split('_')[2]}else{dtype=data.channel.split('_')[2];symbolType=data.channel.split('_')[1]}}if(data.channel==='review'){marketData=data.data;marketData.renew=[];marketDataKey='review';var syAc=currentSymbol.split('/');var sycurrentSymbol=''+syAc[0].toLowerCase()+syAc[1].toLowerCase();if(marketData[sycurrentSymbol]){setEchartsData(marketData[sycurrentSymbol].close,'current',symbolAll[currentSymbol])}sendMessage('WEBSOCKET_DATA','MARKET_DATA',setMarketData(symbolAll,marketData,rate,lan))}if(data.tick&&dtype==='ticker'){if(marketData.renew.indexOf(symbolType)===-1){marketData.renew.push(symbolType)}var isFirstMarketData=true;if(marketDataKey.indexOf(symbolType)===-1&&marketDataKey!=='review'){marketDataKey.push(symbolType)}else{isFirstMarketData=false}marketData[symbolType]=data.tick;if(data.ts-marketTime.socketTime>=marketTime.contrastTime||isFirstMarketData){clearTimeout(marketTime.timeOut);marketTime.socketTime=data.ts;sendMessage('WEBSOCKET_DATA','MARKET_DATA',setMarketData(symbolAll,marketData,rate,lan));marketData.renew=[]}else{clearTimeout(marketTime.timeOut);marketTime.timeOut=null;marketTime.timeOut=setTimeout(function(){sendMessage('WEBSOCKET_DATA','MARKET_DATA',setMarketData(symbolAll,marketData,rate,lan));marketData.renew=[]},marketTime.outTime)}}if(data.channel&&data.channel.indexOf('_kline_')>-1){if(data.event_rep&&data.event_rep==='rep'){sendMessage('WEBSOCKET_DATA','KLINE_DATA_REQ',data)}else{sendMessage('WEBSOCKET_DATA','KLINE_DATA_SUB',data)}}if(symbol===symbolType){if(data.tick&&data.channel.indexOf('depth_step')!==-1){ii+=1;var depthClasses='depth_step'+curreentDepth;var channelArr=data.channel.split('_');var step=channelArr[channelArr.length-1];if(data.channel.indexOf(depthClasses)!==-1){if(data.tick.side){var tick=data.tick;var diff=1;if(tickData[symbolType]&&tickData[symbolType][tick.side][tick.price]&&tickData[symbolType][tick.side][tick.price][1]>tick.volume){diff=2}tickData[symbolType][tick.side][tick.price]=[tick.price,tick.volume,diff];if(!tickData[symbolType].newData){tickData[symbolType].newData=[tick.price]}else if(tickData[symbolType].newData.indexOf(tick.price)<0){tickData[symbolType].newData.push(tick.price)}if(data.ts-depthTime.socketTime>=depthTime.contrastTime){depthTime.socketTime=data.ts;clearTimeout(depthTime.timeOut);depthTime.timeOut=null;sendMessage('WEBSOCKET_DATA','DEPTH_DATA',setDepthData(symbolAll[currentSymbol],tickData[symbolType],rate,depthValue,lan));if(step==='step0'){sendMessage('WEBSOCKET_DATA','ECHARTS_DATA',setEchartsData(tickData[symbolType],false,symbolAll[currentSymbol]))}tickData[symbolType].newData=[]}else{clearTimeout(depthTime.timeOut);depthTime.timeOut=null;depthTime.timeOut=setTimeout(function(){sendMessage('WEBSOCKET_DATA','DEPTH_DATA',setDepthData(symbolAll[currentSymbol],tickData[symbolType],rate,depthValue,lan));if(step==='step0'){sendMessage('WEBSOCKET_DATA','ECHARTS_DATA',setEchartsData(tickData[symbolType],false,symbolAll[currentSymbol]))}tickData[symbolType].newData=[]},depthTime.outTime)}}else{if(data.tick.asks===null)data.tick.asks=[];if(data.tick.buys===null)data.tick.buys=[];tickData[symbolType]={asks:{},buys:{}};data.tick.asks.forEach(function(item){tickData[symbolType].asks[item[0]]=item});data.tick.buys.forEach(function(item){tickData[symbolType].buys[item[0]]=item});sendMessage('WEBSOCKET_DATA','DEPTH_DATA',setDepthData(symbolAll[currentSymbol],tickData[symbolType],rate,depthValue,lan));if(step==='step0'){sendMessage('WEBSOCKET_DATA','ECHARTS_DATA',setEchartsData(tickData[symbolType],false,symbolAll[currentSymbol]))}}}}if(dtype==='trade'){if(data.event_rep==='rep'){setEchartsData(data.data[0],'current',symbolAll[currentSymbol]);var tradeDataRep=setTradeData(symbolAll[currentSymbol],data.data,rate,lan);tradeData=tradeDataRep.tradeData;sendMessage('WEBSOCKET_DATA','TRADE_DATA',tradeDataRep)}if(data.tick&&data.tick.data.length){tradeData.forEach(function(item){item.change=0});data.tick.data.forEach(function(item){item.change=1;tradeData.unshift(item)});if(marketData.renew.indexOf('symbolType')===-1){marketData.renew.push('symbolType')}if(data.ts-tradeTime.socketTime>=tradeTime.contrastTime){clearTimeout(tradeTime.timeOut);tradeTime.socketTime=data.ts;marketData[symbolType].close=tradeData[0]?tradeData[0].price:'';marketData.renew=[symbolType];setEchartsData(tradeData[0],'current',symbolAll[currentSymbol]);sendMessage('WEBSOCKET_DATA','MARKET_DATA',setMarketData(symbolAll,marketData,rate,lan));sendMessage('WEBSOCKET_DATA','TRADE_DATA',setTradeData(symbolAll[currentSymbol],tradeData,rate,lan))}else{clearTimeout(tradeTime.timeOut);tradeTime.timeOut=null;tradeTime.timeOut=setTimeout(function(){marketData[symbolType].close=tradeData[0]?tradeData[0].price:'';setEchartsData(tradeData[0],'current',symbolAll[currentSymbol]);sendMessage('WEBSOCKET_DATA','MARKET_DATA',setMarketData(symbolAll,marketData,rate,lan));sendMessage('WEBSOCKET_DATA','TRADE_DATA',setTradeData(symbolAll[currentSymbol],tradeData,rate,lan))},tradeTime.outTime)}}}}}}};var closeWebSocket=function closeWebSocket(){lockDestroyTop=true;clearTimeout(timeoutTop);MywebSocket.close()};var webSocketSend=function webSocketSend(parameters){var type=parameters.type;var sendType=parameters.sendType;var symbolData=parameters.symbolData;var symbolList=parameters.symbolList;depthValue=parameters.depthValue;currentSymbol=symbolData;if(type==='Review'){marketReviewSend()}if(type==='Market'&&symbolData&&symbolList){markteWsSend(sendType,symbolData,symbolList);symbolListArr=symbolList}if(type==='Trade'&&symbolData){tradeWsSend(sendType,symbolData)}if(type==='Depth'&&symbolData){curreentDepth=symbolList;depthWsSend(sendType,symbolData,curreentDepth)}};emitter.on('websocketReceive',function(event){var data=event.data,type=event.type;if(type==='CREAT_WEBSOCKET'){if(!MywebSocket){console.log(data);webSocketUrl=data.wsUrl;lan=data.lan;rate=data.rate;symbolAll=data.symbolAll;creatWebSocket(data.wsUrl)}else{sendMessage('WEBSOCKET_ON_OPEN',MywebSocket.readyState)}}if(type==='CLOSE_WEBSOCKET'){closeWebSocket(data)}if(type==='WEBSOCKET_SEND'){if(MywebSocket.readyState===1){webSocketSend(data)}}if(type==='WEBSOCKET_KLINE_SEND'){symbolCurrent=data.symbolCurrent;klineWsSend(data)}if(type==='TRADE_QUEUE_DATA'){tradeData=data}});emitter.emit('websocket-worker-ready')});})()