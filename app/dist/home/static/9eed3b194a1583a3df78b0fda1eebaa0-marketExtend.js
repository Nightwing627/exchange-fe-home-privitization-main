var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}(function(){var _window$BlockChainUti=window.BlockChainUtils,myStorage=_window$BlockChainUti.myStorage,getCoinShowName=_window$BlockChainUti.getCoinShowName,getScript=_window$BlockChainUti.getScript;var _window=window,emitter=_window.emitter,location=_window.location,fetchData=_window.fetchData;var MarketExtend=function(){function MarketExtend(){_classCallCheck(this,MarketExtend)}_createClass(MarketExtend,[{key:'sortIcon',value:function sortIcon(v,sortValue,sortSell){var str='#icon-a_17';if(v===sortValue){if(sortSell){str='#icon-a_17_1'}else{str='#icon-a_17_2'}}return str}},{key:'initScroll',value:function initScroll(){var _this=this;if(window.IScroll){this.scroll=new window.PerfectScrollbar(this.$homeTbody)}else{getScript(window.staticDomain+'/home/static/js/perfect-scrollbar.min.js').then(function(){_this.scroll=new window.PerfectScrollbar(_this.$homeTbody)})}}},{key:'dataLength',value:function dataLength(tableData){var len=0;tableData.forEach(function(item){if(tableData.length>1){len+=1}item.data.forEach(function(){len+=1})});return len}},{key:'tableHeight',value:function tableHeight(dataLength){var h=300;var spk=30;if(dataLength>5&&dataLength<spk){h=56*dataLength}else if(dataLength>=spk){h=56*spk}return h}},{key:'createTableHead',value:function createTableHead(){var _this2=this;var html='';this.columns.forEach(function(item,index){var icon='';var className='thead-label';if(item.sortable){className='thead-label sortable';icon='<svg aria-hidden="true" class="icon icon-14">\n                                      <use xlink href="'+_this2.sortIcon(item.key,'sort',false)+'"></use>\n                                    </svg>'}html+='<li>\n                                  <span class="'+className+'" data-index="'+index+'">\n                                    '+item.title+'\n                                    '+icon+'\n                                  </span>\n                            </li>'});this.$homeThead.innerHTML=html;this.bindTitleEvent()}},{key:'createMarketTitle',value:function createMarketTitle(dataList,coinList){var _this3=this;var html='';html+='<li class="c-8-bd" data-market="myMarket">\n                         '+this.locale.marketSet+'\n                        </li>';dataList.forEach(function(item){var className='';if(_this3.marketCurrent===item){className=_this3.hoverClass+' selected'}html+='<li class="'+className+'" data-market="'+item+'">\n                            '+getCoinShowName(item,coinList)+'\n                            </li>'});this.$marketTitle.innerHTML=html}},{key:'switchMarket',value:function switchMarket(data){if(this.createIng)return;this.listfilter=null;this.marketCurrent=data;this.createIng=true;if(data!=='myMarket'){myStorage.set('homeMarkTitle',data)}emitter.emit('SWITCH-MARKET',data)}},{key:'overHandler',value:function overHandler(target){var cl='f-1-cl c-3-bg';if(this.tableListOverClass){cl=this.tableListOverClass}var liBorder='c-5-bd';if(typeof this.liBorder==='string'){liBorder=this.liBorder}target.className='home-tbody-li '+liBorder+' '+cl}},{key:'outHandler',value:function outHandler($list){var _this4=this;var liBorder='c-5-bd';if(typeof this.liBorder==='string'){liBorder=this.liBorder}var liColor='f-1-cl';if(typeof this.liColor==='string'){liColor=this.liColor}$list.forEach(function(item){item.className='home-tbody-li '+liBorder+' '+liColor+' '+(_this4.tableBg?_this4.tableBg:'')})}},{key:'setMyMarket',value:function setMyMarket(symbol){var _this5=this;var url='/fe-ex-api/common/update_optional_symbol';if(this.optional_symbol_server_open===1){url='/fe-ex-api/optional/update_symbol'}if(!this.setMyMarketSwitch)return;this.setMyMarketSwitch=false;var mySymbol=myStorage.get('mySymbol')||[];var addOrDelete=true;if(mySymbol.length&&mySymbol.indexOf(symbol)>-1){mySymbol=mySymbol.filter(function(item){return item!==symbol});addOrDelete=false}else{mySymbol.push(symbol);addOrDelete=true}if(this.optional_symbol_server_open===1&&window.isLogin){fetchData({url:url,method:'post',params:{operationType:addOrDelete===true?'1':'2',symbols:symbol}}).then(function(data){if(data.code==='0'){_this5.setMyMarketSwitch=true;_this5.mySymbolList=mySymbol;myStorage.set('mySymbol',mySymbol)}else{emitter.emit('tip',{text:data.msg,type:'error'})}})}else{this.setMyMarketSwitch=true;this.mySymbolList=mySymbol;myStorage.set('mySymbol',mySymbol)}}},{key:'changeIcon',value:function changeIcon(iconHtml){if(iconHtml.indexOf('c_11_1')>-1){return'<svg class="icon icon-16" aria-hidden="true">\n                            <use xlink:href="#icon-c_11">\n                          </use></svg>'}return'<svg class="icon icon-16" aria-hidden="true">\n                            <use xlink:href="#icon-c_11_1">\n                          </use></svg>'}},{key:'marketIconClick',value:function marketIconClick(target){var realcoin=target.dataset.realcoin;target.innerHTML=this.changeIcon(target.innerHTML);this.setMyMarket(realcoin);emitter.emit('SWITCH-STORE',realcoin)}},{key:'unBindTableListEvent',value:function unBindTableListEvent(){var _this6=this;var $list=this.$homeTbody.querySelectorAll('.home-tbody-li');var $markeIcon=this.$homeTbody.querySelectorAll('.marketIcon');var $evenSymbols=this.$homeTbody.querySelectorAll('.evenSymbol');$list.forEach(function(target){target.removeEventListener('mouseover',_this6.overHandler,false);target.removeEventListener('mouseout',_this6.outHandler,false)});$evenSymbols.forEach(function(target){target.removeEventListener('click',_this6.everySymbolClick,false)});$markeIcon.forEach(function(target){target.removeEventListener('click',_this6.marketIconClick,false)})}},{key:'everySymbolClick',value:function everySymbolClick(target){var etfOpen=target.dataset.etfOpen;var data=target.dataset.id;myStorage.set('sSymbolName',data);if(etfOpen){myStorage.set('markTitle','ETF')}else{myStorage.set('markTitle',data.split('/')[1])}location.href='/trade/'+data.replace('/','_')}},{key:'bindTableListEvent',value:function bindTableListEvent(){var _this7=this;var $list=this.$homeTbody.querySelectorAll('.home-tbody-li');var $markeIcon=this.$homeTbody.querySelectorAll('.marketIcon');var $evenSymbols=this.$homeTbody.querySelectorAll('.evenSymbol');$evenSymbols.forEach(function(target){target.addEventListener('click',_this7.everySymbolClick.bind(_this7,target),false)});$markeIcon.forEach(function(target){target.addEventListener('click',_this7.marketIconClick.bind(_this7,target),false)});$list.forEach(function(target){target.addEventListener('mouseover',_this7.overHandler.bind(_this7,target),false);target.addEventListener('mouseout',_this7.outHandler.bind(_this7,$list),false)})}},{key:'sort',value:function sort(v){if(this.createIng)return;if(!v.sortable)return;if(this.sortValue!==v.key){this.sortValue=v.key;this.sortSell=true}else{this.sortSell=!this.sortSell}}},{key:'changeSortableIcon',value:function changeSortableIcon(target){var $use=target.querySelector('use');var href=$use.getAttribute('href');this.$homeThead.querySelectorAll('.sortable').forEach(function(item){item.querySelector('use').setAttribute('href','#icon-a_17')});if(href.indexOf('a_17_2')>-1){$use.setAttribute('href','#icon-a_17_1')}else{$use.setAttribute('href','#icon-a_17_2')}}},{key:'bindTitleEvent',value:function bindTitleEvent(){var _this8=this;this.$homeThead.querySelectorAll('.sortable').forEach(function(item){item.addEventListener('click',function(){_this8.sort(_this8.columns[item.dataset.index]);_this8.changeSortableIcon(item);emitter.emit('SWITCH-MARKET',myStorage.get('homeMarkTitle'))},false)})}},{key:'bindEvent',value:function bindEvent(){var _this9=this;this.$marketTitle.addEventListener('click',function(e){var target=e.target;var currentMarket=target.dataset.market;_this9.$marketTitle.querySelectorAll('li').forEach(function(item){item.className=''});target.className=_this9.hoverClass+' selected';_this9.switchMarket(currentMarket)},false)}},{key:'init',value:function init(data){var _this10=this;this.market=data.market.market;this.symbolAll=data.symbolAll;this.coinList=data.market.coinList;this.createMarketTitle(data.market.marketSort,data.market.coinList);this.createTableHead();this.bindEvent();emitter.on('login',function(){_this10.isLogin=window.isLogin})}},{key:'createTable',value:function createTable(dataList){var _this11=this;var list=JSON.parse(JSON.stringify(dataList));var html='';this.tableTreeData={};this.tableTree={};var dataLen=Object.keys(list).length;var liBorder='c-5-bd';if(typeof this.liBorder==='string'){liBorder=this.liBorder}var liColor='f-1-cl';if(typeof this.liColor==='string'){liColor=this.liColor}if(dataLen){this.$homeNodata.style.display='none'}list.forEach(function(data){var childHtml='';data.data.forEach(function(item,index){var evenSymbol=item.data[0][1].iconSvg.match(/>(.+)</)[1];if(!_this11.tableTreeData[evenSymbol]){_this11.tableTreeData[evenSymbol]={};_this11.tableTree[evenSymbol]={}}_this11.tableTreeData[evenSymbol].marketIcon=item.data[0][0].iconSvg;_this11.tableTreeData[evenSymbol].price=item.data[1][0].text;_this11.tableTreeData[evenSymbol].subPrice=item.data[1][0].subContent.text;_this11.tableTreeData[evenSymbol].amount=item.data[2][0].text;_this11.tableTreeData[evenSymbol].amountClass=item.data[2][0].classes;childHtml+='<li class="home-tbody-li '+_this11.tableBg+'" data-coin="'+evenSymbol+'" data-realCoin="'+item.id+'">\n                                        <!-- \u5E01\u5BF9 -->\n                                        <div class="even">\n                                        <span class="marketIndex">'+(index+1)+'</span>\n                          <span class="marketIcon" data-coin="'+evenSymbol+'" data-realCoin="'+item.id+'">'+item.data[0][0].iconSvg+'</span>\n                                            <span class="evenSymbol" data-id="'+item.id+'" data-eftOpen="'+item.etfOpen+'">'+item.data[0][1].iconSvg+'</span>\n                                            '+(item.etfOpen&&_this11.marketCurrent!=='ETF'?'<span class="eft-class u-8-bd u-8-cl">ETF</span>':'')+'\n                                        </div>\n                                        <!-- \u6700\u65B0\u4EF7 -->\n                                        <div class="even newPrice">\n                                            <p class="price">'+item.data[1][0].text+'</p>\n                                            <p class="subPrice">'+item.data[1][0].subContent.text+'</p>\n                                        </div>\n                                        <!-- \u6DA8\u8DCC\u5E45 -->\n                                        <div class="even">\n                                            <div class="amount '+item.data[2][0].classes.join(' ')+'">'+item.data[2][0].text+'</div>\n                                        </div>\n                                        <div class="even buy-button" data-coin="'+evenSymbol+'">Buy</div>\n                                    </li>'});if(dataLen>1){html+='<div class="home-tbody" data-coin="'+data.title+'">\n                                 <div>\n                                     <div class="home-tbody-title c-5-bd '+(_this11.titleBg?_this11.titleBg:'')+'">\n                                         <span class="lable c-5-bd">'+data.title+'</span>\n                                     </div>\n                                     <ul class="home-tbody-list">'+childHtml+'</ul>\n                                 </div>\n                             </div>'}else{html+='<div class="home-tbody" data-coin="'+data.title+'">\n                                 <div>\n                                     <ul class="home-tbody-list">'+childHtml+'</ul>\n                                 </div>\n                             </div>'}});this.$homeTbody.innerHTML='<div class="scroll-warper">'+html+'</div>';var lis=this.$homeTbody.querySelectorAll('.home-tbody-li');lis.forEach(function(item){var coin=item.dataset.coin;_this11.tableTree[coin].price=item.querySelector('.price');_this11.tableTree[coin].subPrice=item.querySelector('.subPrice');_this11.tableTree[coin].amount=item.querySelector('.amount');_this11.tableTree[coin].highest=item.querySelector('.highest');_this11.tableTree[coin].lowest=item.querySelector('.lowest');_this11.tableTree[coin].deal=item.querySelector('.deal');_this11.tableTree[coin].volume=item.querySelector('.volume');_this11.tableTree[coin].marketIcon=item.querySelector('.marketIcon');item.querySelector('.buy-button').addEventListener('click',function(){location.href='/trade/'+coin.replace('/','_')},false)});var len=this.dataLength(list);var height=this.tableHeight(len);this.$homeLoading.style.display='none';if(!list.length){this.$homeNodata.style.display='block'}else{this.$homeTbody.style.height=height+'px';this.$homeTbody.style.display='block'}this.createIng=false;this.rebuild=false;this.bindTableListEvent();if(this.isScroll&&lis.length>20){this.initScroll(this.$homeTbody.querySelector('.scroll-warper'))}else if(window.IScroll){this.scroll.destroy()}list=null}},{key:'dataSort',value:function dataSort(v){var _this12=this;if(this.sortValue.length){return v.sort(function(a,b){var first=a;var end=b;if(_this12.sortSell){first=b;end=a}switch(_this12.sortValue){case'roses':return(parseFloat(first.data[2][0].sortVal)||0)-(parseFloat(end.data[2][0].sortVal)||0);case'closes':return(parseFloat(first.data[1][0].sortVal)||0)-(parseFloat(end.data[1][0].sortVal)||0);default:return(parseFloat(first.data[0][1].sortVal)||0)-(parseFloat(end.data[0][1].sortVal)||0);}})}return v}},{key:'tableData',value:function tableData(){var _this13=this;var arr=[];var result=[];if(this.halveAreaData.length){var data=this.dataSort(this.halveAreaData);arr.push({title:this.locale.halving,titleIndex:0,data:data})}if(this.MainAreaData.length){var _data=this.dataSort(this.MainAreaData);arr.push({title:this.locale.maincon,data:_data})}if(this.CreateAreaData.length){var _data2=this.dataSort(this.CreateAreaData);arr.push({title:this.locale.newcon,data:_data2})}if(this.SeeAreaData.length){var _data3=this.dataSort(this.SeeAreaData);arr.push({title:this.locale.seecon,data:_data3})}if(this.unsealAreaData.length){var _data4=this.dataSort(this.unsealAreaData);arr.push({title:this.locale.unseal,data:_data4})}arr.forEach(function(el){var item=el;var data=el.data.filter(function(e){return e.isShow||_this13.listfilter||_this13.marketCurrent==='myMarket'});if(data.length){item.data=data;var newItem=item;item.data.forEach(function(citem,index){newItem.data[index].etfOpen=_this13.symbolAll[citem.id].etfOpen});result.push(newItem)}});return result}},{key:'filterArea',value:function filterArea(){var _this14=this;var MainAreaFilter=[];var CreateAreaFilter=[];var SeeAreaFilter=[];var hideAreaFilter=[];var unsealAreaFilter=[];var halveAreaFilter=[];var data=JSON.parse(JSON.stringify(this.market));Object.keys(data).forEach(function(item){Object.keys(data[item]).forEach(function(citem){var _data$item$citem=data[item][citem],newcoinFlag=_data$item$citem.newcoinFlag,name=_data$item$citem.name;if(_this14.coinList[name.split('/')[0]]&&_this14.coinList[name.split('/')[0]].isOvercharge&&_this14.coinList[name.split('/')[0]].isOvercharge.toString()==='1'){unsealAreaFilter.push(citem)}else if(newcoinFlag===1){CreateAreaFilter.push(citem)}else if(newcoinFlag===2){SeeAreaFilter.push(citem)}else if(newcoinFlag===0){MainAreaFilter.push(citem)}else if(newcoinFlag===3){halveAreaFilter.push(citem)}})});this.MainAreaFilter=MainAreaFilter;this.CreateAreaFilter=CreateAreaFilter;this.SeeAreaFilter=SeeAreaFilter;this.hideAreaFilter=hideAreaFilter;this.unsealAreaFilter=unsealAreaFilter;this.halveAreaFilter=halveAreaFilter}},{key:'setData',value:function setData(val){var _this15=this;var isSearch=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var MainArea=[];var CreateArea=[];var SeeArea=[];var hideArea=[];var unsealArea=[];var halveArea=[];val.forEach(function(item){if(_this15.MainAreaFilter.indexOf(item.id)!==-1){MainArea.push(item)}if(_this15.CreateAreaFilter.indexOf(item.id)!==-1){CreateArea.push(item)}if(_this15.SeeAreaFilter.indexOf(item.id)!==-1){SeeArea.push(item)}if(_this15.hideAreaFilter.indexOf(item.id)!==-1){hideArea.push(item)}if(_this15.unsealAreaFilter.indexOf(item.id)!==-1&&!isSearch){unsealArea.push(item)}if(_this15.halveAreaFilter.indexOf(item.id)!==-1){halveArea.push(item)}});this.MainAreaData=MainArea;this.CreateAreaData=CreateArea;this.SeeAreaData=SeeArea;this.hideAreaData=hideArea;this.unsealAreaData=unsealArea;this.halveAreaData=halveArea}},{key:'resloveData',value:function resloveData(val,isSearch){this.marketDataList_bar=val;var data=val;if(this.listfilter){var reg=new RegExp(this.listfilter,'gim');data=this.marketDataList_bar.filter(function(item){return item.showName.match(reg)})}this.setData(data,isSearch)}},{key:'changeTable',value:function changeTable(dataList){var _this16=this;dataList.forEach(function(data){data.data.forEach(function(item){var evenSymbol=item.data[0][1].iconSvg.match(/>(.+)</)[1];if(_this16.tableTreeData[evenSymbol]){if(_this16.tableTreeData[evenSymbol].marketIcon!==item.data[0][0].iconSvg){_this16.tableTree[evenSymbol].marketIcon.innerHTML=item.data[0][0].iconSvg;_this16.tableTreeData[evenSymbol].marketIcon=item.data[0][0].iconSvg}if(_this16.tableTreeData[evenSymbol].price!==item.data[1][0].text){_this16.tableTree[evenSymbol].price.innerHTML=item.data[1][0].text;_this16.tableTreeData[evenSymbol].price=item.data[1][0].text}if(_this16.tableTreeData[evenSymbol].subPrice!==item.data[1][0].subContent.text){_this16.tableTree[evenSymbol].subPrice.innerHTML=item.data[1][0].subContent.text;_this16.tableTreeData[evenSymbol].subPrice=item.data[1][0].subContent.text}if(_this16.tableTreeData[evenSymbol].amount!==item.data[2][0].text){_this16.tableTree[evenSymbol].amount.innerHTML=item.data[2][0].text;_this16.tableTreeData[evenSymbol].amount=item.data[2][0].text}if(_this16.tableTreeData[evenSymbol].amountClass!==item.data[2][0].classes){_this16.tableTree[evenSymbol].amount.className='amount '+item.data[2][0].classes.join(' ');_this16.tableTreeData[evenSymbol].amountClass=item.data[2][0].classes}}})})}},{key:'initTable',value:function initTable(data){var inData=JSON.parse(JSON.stringify(data));data=null;this.unBindTableListEvent();this.filterArea();this.resloveData(inData);this.tableDataList=this.tableData();if(!this.firstLoad||this.rebuild){this.$homeTbody.style.display='none';this.$homeLoading.style.display='block';this.firstLoad=true;this.createIng=true;this.createTable(this.tableDataList)}else if(!this.createIng&&!this.rebuild){this.changeTable(this.tableDataList)}}}]);return MarketExtend}();window.MarketExtend=MarketExtend})();